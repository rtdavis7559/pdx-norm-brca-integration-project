---
title: "10X Norm/BRCA and SmartSeq2 TNBC PDX Model Integration"
author: "Ryan and Paige"
date: "4/5/2020"
output: html_document
---

## Load R packages

```{r load.packages, echo = FALSE}
library(Seurat)
library(dplyr)
library(reshape2)
library(ggplot2)
library(patchwork)
library(cowplot)
library(pheatmap)
library(RColorBrewer)
library(dendsort)
```

## Load in seurat objects

```{r load.objects, eval = FALSE, echo = FALSE}
#HCI001
load("seurat-objects/hci001.expected.counts.trimmed.seurat3.object.Rda")
#HCI002
load("seurat-objects/hci002.expected.counts.trimmed.seurat3.object.Rda")
#HCI010
load("seurat-objects/hci010.expected.counts.trimmed.seurat3.object.Rda")
#Norm/BRCA
load("seurat-objects/norm.brca.integrated.epithelial.Rda")
```

## Set Assay to Counts for all Datasets

```{r subset.normbrca.dataset, eval = FALSE, echo = FALSE}
DefaultAssay(norm.brca.integrated.epithelial)<-"RNA"
DefaultAssay(p01.counts)<-"RNA"
DefaultAssay(p02.counts)<-"RNA"
DefaultAssay(p10.counts)<-"RNA"
```

## Data Integration - scTransform

```{r sctransform.generate.object.list, eval = FALSE}
#To construct a reference, we will identify ‘anchors’ between the individual datasets. First, we combine each Seurat object into a list, with each dataset as an element.
#The list() function groups elements together in the form of list("X1"=Y1,"X2",Y2,...), where Xn is the name you want the list element to be called and Yn is the component you want added to the list. For this analysis, we want to keep track of which Seurat object belongs to which model/patient.
norm.brca.epithelial.patients <- SplitObject(norm.brca.integrated.epithelial,"individual")

norm.brca.ind1<-norm.brca.epithelial.patients$ind1
norm.brca.ind10<-norm.brca.epithelial.patients$ind10
norm.brca.ind2<-norm.brca.epithelial.patients$ind2
norm.brca.ind3<-norm.brca.epithelial.patients$ind3
norm.brca.ind4<-norm.brca.epithelial.patients$ind4
norm.brca.ind9<-norm.brca.epithelial.patients$ind9

sctransform.object.list<-list("hci001"=p01.counts,"hci002"=p02.counts,"hci010"=p10.counts,"ind1"=norm.brca.ind1,"ind10"=norm.brca.ind10, "ind2"=norm.brca.ind2,"ind3"=norm.brca.ind3,"ind4"=norm.brca.ind4,"ind9"=norm.brca.ind9)
```
```{r sctransform.normalize.objects, eval = FALSE}
#Conceptually, this workflow is very similar to what we have previously introduced, where we ‘correct’ (or harmonize) log-normalized expression values across datasets. Here, instead, we will harmonize the Pearson residuals that are output from SCTransform.
#First, setup the Seurat object list, and run SCTransform on each object separately
for (i in 1:length(sctransform.object.list)) {
    sctransform.object.list[[i]] <- SCTransform(sctransform.object.list[[i]], verbose = FALSE)
}
```
```{r sctransform.feature.selection, eval = FALSE}
#Next, select features for downstream integration, and run PrepSCTIntegration, which ensures that all necessary Pearson residuals have been calculated.
#Running on 3000 selected features (may test others later)
norm.brca.pdx.features.3000 <- SelectIntegrationFeatures(object.list = sctransform.object.list, 
                                                         nfeatures = 3000)
#need to increase globals size limit otherwise the next line will error (will need to be adjusted for size of future datasets)
options(future.globals.maxSize = (6000*1024^2))

norm.brca.pdx.features.list.3000 <- PrepSCTIntegration(object.list = sctransform.object.list, 
                                                  anchor.features = norm.brca.pdx.features.3000, 
                                                  verbose = FALSE)
```
```{r sctransform.integrate, eval = FALSE}
#Next, identify anchors and integrate the datasets. Commands are identical to the standard workflow, but make sure to set normalization.method = 'SCT':

norm.brca.pdx.anchors <- FindIntegrationAnchors(object.list = norm.brca.pdx.features.list.3000, normalization.method = "SCT", 
    anchor.features = norm.brca.pdx.features.3000, verbose = FALSE)
memory.size(max = TRUE)
norm.brca.pdx.integrated <- IntegrateData(anchorset = norm.brca.pdx.anchors, normalization.method = "SCT", 
    verbose = FALSE)

```

##Dimentionality Reduction

```{r sctransform.dim.reduction, eval = FALSE}
#Now proceed with downstream analysis (i.e. visualization, clustering) on the integrated dataset. Commands are identical to the standard workflow, but do not run the ScaleData function after integration. You can see that after integration, cells group by their biological cell type (which has been pre-annotated), instead of by their underlying technology.

norm.brca.pdx.integrated <- RunPCA(norm.brca.pdx.integrated, verbose = FALSE)
norm.brca.pdx.integrated <- RunUMAP(norm.brca.pdx.integrated, dims = 1:30)
```

##Adding MetaData

```{r add.meta.data, eval = FALSE, echo = FALSE}
load(file="E:/Scripts/Seurat/Seurat3_Objects/norm.brca.pdx.expectedcounts.integrated.sctransform.3000features.SeuratObject.Rda")


head(norm.brca.pdx.integrated@meta.data)
#Generate new list for the dataset type
combined_status <- list ()
#Adding the five different classifications to the list 
combined_status[grep("NORMAL",norm.brca.pdx.integrated$Status)] <- "Normal"
combined_status[grep("BRCA",norm.brca.pdx.integrated$Status)] <- "BRCA"
combined_status[grep("LU", rownames(norm.brca.pdx.integrated@meta.data))] <- "Metastatic"
combined_status[grep("LN", rownames(norm.brca.pdx.integrated@meta.data))] <- "Metastatic"
#Get the tumor cells from the PDX models that are tumor cells 
combined_status[grep("_T_", rownames(norm.brca.pdx.integrated@meta.data))] <- "Tumor"
#Add new metadata column 
norm.brca.pdx.integrated[["combined_status"]] <- as.character(combined_status)

#Generate new list for the cell type
combined_individual <- list()
#Get the PDX models from each individual
combined_individual[grep("HCI001", rownames(norm.brca.pdx.integrated@meta.data))] <- "hci001"
combined_individual[grep("HCI002", rownames(norm.brca.pdx.integrated@meta.data))] <- "hci002"
combined_individual[grep("HCI010", rownames(norm.brca.pdx.integrated@meta.data))] <- "hci010"
#Get the individuals from Kevins Norm/BRCA dataset 
combined_individual[which(norm.brca.pdx.integrated$individual == "ind1")] <- "ind1"
combined_individual[which(norm.brca.pdx.integrated$individual == "ind10")] <- "ind10"
combined_individual[which(norm.brca.pdx.integrated$individual == "ind2")] <- "ind2"
combined_individual[which(norm.brca.pdx.integrated$individual == "ind3")] <- "ind3"
combined_individual[which(norm.brca.pdx.integrated$individual == "ind4")] <- "ind4"
combined_individual[which(norm.brca.pdx.integrated$individual == "ind9")] <- "ind9"
#Add new column 
norm.brca.pdx.integrated[["combined_individual"]] <- as.character(combined_individual)

#Generate new list for the dataset type
combined_chemistry <- list ()
combined_chemistry[grep("LU", rownames(norm.brca.pdx.integrated@meta.data))] <- "smartseq2"
combined_chemistry[grep("LN", rownames(norm.brca.pdx.integrated@meta.data))] <- "smartseq2"
combined_chemistry[grep("_T_", rownames(norm.brca.pdx.integrated@meta.data))] <- "smartseq2"
combined_chemistry[which(norm.brca.pdx.integrated$individual == "ind1")] <- "10x_v1"
combined_chemistry[which(norm.brca.pdx.integrated$individual == "ind10")] <- "10x_v2"
combined_chemistry[which(norm.brca.pdx.integrated$individual == "ind2")] <- "10x_v1"
combined_chemistry[which(norm.brca.pdx.integrated$individual == "ind3")] <- "10x_v2"
combined_chemistry[which(norm.brca.pdx.integrated$individual == "ind4")] <- "10x_v2"
combined_chemistry[which(norm.brca.pdx.integrated$individual == "ind9")] <- "10x_v2"
#Add new metadata column 
norm.brca.pdx.integrated[["combined_chemistry"]] <- as.character(combined_chemistry)

#Generate new list for the dataset type
combined_cell_type <- list ()
combined_cell_type[grep("LU", rownames(norm.brca.pdx.integrated@meta.data))] <- "Metastatic"
combined_cell_type[grep("LN", rownames(norm.brca.pdx.integrated@meta.data))] <- "Metastatic"
#Get the tumor cells from the PDX models that are tumor cells 
combined_cell_type[grep("_T_", rownames(norm.brca.pdx.integrated@meta.data))] <- "Tumor"
combined_cell_type[which(norm.brca.pdx.integrated$Cell.Type == "Basal")] <- "Basal"
combined_cell_type[which(norm.brca.pdx.integrated$Cell.Type == "Luminal_1")] <- "Luminal 1"
combined_cell_type[which(norm.brca.pdx.integrated$Cell.Type == "Luminal_2")] <- "Luminal 2"
combined_cell_type[which(norm.brca.pdx.integrated$Cell.Type == "Unclassified")] <- "Unclassified"
#Add new metadata column 
norm.brca.pdx.integrated[["combined_cell_type"]] <- as.character(combined_cell_type)

```

##Visualizing Data

```{r sctransform.normalize, eval = FALSE, echo = FALSE}
DefaultAssay(norm.brca.pdx.integrated)<-"RNA"
norm.brca.pdx.integrated<-NormalizeData(norm.brca.pdx.integrated,verbose = FALSE)
```
```{r sctransform.visualize.known.markers.pdx, fig.height = 4, fig.width=8}
load(file="E:\\Scripts\\Seurat\\Seurat3_Objects\\norm.brca.pdx.expectedcounts.integrated.sctransform.3000features.SeuratObject.Rda")
VlnPlot(norm.brca.pdx.integrated,c("PHLDA2"),group.by = "combined_individual",split.by="combined_status", pt.size = 0, multi.group = T, assay = "RNA")
VlnPlot(norm.brca.pdx.integrated,c("BHLHE40"),group.by = "combined_individual",split.by="combined_status", pt.size = 0, multi.group = T, assay = "RNA")
```
```{r sctransform.visualize.known.markers.normal, fig.height = 12, fig.width=8}
VlnPlot(norm.brca.pdx.integrated,c("KRT5","KRT14","KRT8","KRT18","SLPI","ANKRD30A"),group.by = "combined_cell_type", pt.size = 0, assay = "RNA",ncol = 2)
```
```{r sctransform.visualize.umap, fig.height = 10, fig.width=10}
plot1<-DimPlot(norm.brca.pdx.integrated,reduction = "umap",split.by = "combined_chemistry", group.by = "combined_chemistry")
plot2<-DimPlot(norm.brca.pdx.integrated,reduction = "umap",group.by = "combined_individual", split.by = "combined_individual")
plot3<-DimPlot(norm.brca.pdx.integrated,reduction = "umap",group.by = "combined_status", split.by = "combined_status")
plot4<-DimPlot(norm.brca.pdx.integrated,reduction = "umap",group.by = "combined_cell_type", split.by = "combined_cell_type")

plot_grid(plot1,plot2,plot3,plot4, ncol = 1)
```

##Cluster Identification and Marker Genes

```{r sctransform.find.neighbors, eval = FALSE}
#Switch back to integrated slot for identifying clusters
#Match 30 PCs to original UMAP clustering
DefaultAssay(norm.brca.pdx.integrated)<-"integrated"
norm.brca.pdx.integrated <- FindNeighbors(norm.brca.pdx.integrated, dims = 1:30, verbose = FALSE)
```
```{r sctransform.find.clusters, eval = FALSE}
norm.brca.pdx.integrated <- FindClusters(norm.brca.pdx.integrated, verbose = FALSE, resolution = 0.5)
norm.brca.pdx.integrated <- FindClusters(norm.brca.pdx.integrated, verbose = FALSE, resolution = 0.1)
norm.brca.pdx.integrated <- FindClusters(norm.brca.pdx.integrated, verbose = FALSE, resolution = 1)
```
```{r sctransform.visualize.clusters.0.1, fig.height = 8, fig.width=8}
DimPlot(norm.brca.pdx.integrated, group.by = "integrated_snn_res.0.1",label = T, pt.size = 1)
```
```{r sctransform.visualize.clusters.0.5, fig.height = 8, fig.width=8}
DimPlot(norm.brca.pdx.integrated, group.by = "integrated_snn_res.0.5",label = T, pt.size = 1)
```
```{r sctransform.visualize.clusters.1, fig.height = 8, fig.width=8}
DimPlot(norm.brca.pdx.integrated, group.by = "integrated_snn_res.1",label = T, pt.size = 1)
```
```{r sctransform.identify.markers.0.5, eval = FALSE}
#Find markers for Res 0.5, RNA slot
Idents(norm.brca.pdx.integrated)<-"integrated_snn_res.0.5"
norm.brca.pdx.integrated.res0.5.RNA.markers <- FindAllMarkers(norm.brca.pdx.integrated, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25, assay = "RNA")
write.table(norm.brca.pdx.integrated.res0.5.RNA.markers, file = "marker_genes/norm.brca.pdx.integrated.res0.5.RNA.markers.txt")
#Need to scale values in RNA slot
all.genes<-rownames(norm.brca.pdx.integrated@assays$RNA)
norm.brca.pdx.integrated<-ScaleData(norm.brca.pdx.integrated,features = all.genes,assay = "RNA")
```
```{r sctransform.visualize.markers.0.5.heatmap, fig.height=5, fig.width=10}
Idents(norm.brca.pdx.integrated)<-"integrated_snn_res.0.5"
norm.brca.pdx.integrated.res0.5.RNA.markers<-read.table("marker_genes/norm.brca.pdx.integrated.res0.5.RNA.markers.txt")
top10 <- norm.brca.pdx.integrated.res0.5.RNA.markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_logFC)
top10 <- as.character(top10$gene)
DoHeatmap(norm.brca.pdx.integrated, features = top10, assay = "RNA") + NoLegend()
```
```{r sctransform.markers.0.5.table, results = 'asis', echo = FALSE}
library(knitr)
kable(norm.brca.pdx.integrated.res0.5.RNA.markers %>% group_by(cluster) %>% top_n(n = 5, wt = avg_logFC), caption = "Res 0.5 RNA Markers")
```

## Integrate PDX Cells by Cell Type

```{r sctransform.identify.PDX.cells.by.cell.type, eval = FALSE, echo = FALSE, echo=FALSE}
#This initial part of the analysis to subset the cells was performed on the Macbook
DimPlot(norm.brca.pdx.integrated, group.by = "combined_cell_type")
plot1<-DimPlot(norm.brca.pdx.integrated, group.by = "combined_cell_type")
#The following lines were performed in the console to select corresponding cells
norm.brca.pdx.integrated<-CellSelector(plot1, norm.brca.pdx.integrated, ident = "integrated_basal")
norm.brca.pdx.integrated<-CellSelector(plot1, norm.brca.pdx.integrated, ident = "integrated_luminal1")
norm.brca.pdx.integrated<-CellSelector(plot1, norm.brca.pdx.integrated, ident = "integrated_luminal2")

#Create new meta.data column for integrated celltypes
norm.brca.pdx.integrated[["integrated_cell_type"]]<-Idents(norm.brca.pdx.integrated)
norm.brca.pdx.integrated[["integrated_cell_type_renamed"]]<-norm.brca.pdx.integrated$integrated_cell_type
levels(norm.brca.pdx.integrated$integrated_cell_type_renamed)<-c("luminal2","luminal1","basal","other","other","other","other","other","other","other","other")

#Save new object and transfer back to PC to rerun integration
#save(norm.brca.pdx.integrated, file = "/Users/ryan/Documents/Raw_Matrices/norm.brca.pdx.expectedcounts.integrated.sctransform.3000features.SeuratObject.Rda")
```
```{r sctransform.subset.seurat.objects.cell.type, eval = FALSE, echo=FALSE}
norm.brca.pdx.list<-SplitObject(norm.brca.pdx.integrated, split.by = "combined_individual")
hci001<-norm.brca.pdx.list$hci001
hci002<-norm.brca.pdx.list$hci002
hci010<-norm.brca.pdx.list$hci010
```

## Integrate PDX cells with Basal Cells

```{r sctransform.subset.norm.brca.basal, eval=FALSE, echo=FALSE}
ind1<-norm.brca.pdx.list$ind1
Idents(ind1)<- "integrated_cell_type_renamed"
ind1.basal<-subset(ind1, idents = "basal")

ind10<-norm.brca.pdx.list$ind10
Idents(ind10)<- "integrated_cell_type_renamed"
ind10.basal<-subset(ind10, idents = "basal")

ind2<-norm.brca.pdx.list$ind2
Idents(ind2)<- "integrated_cell_type_renamed"
ind2.basal<-subset(ind2, idents = "basal")

ind3<-norm.brca.pdx.list$ind3
Idents(ind3)<- "integrated_cell_type_renamed"
ind3.basal<-subset(ind3, idents = "basal")

ind4<-norm.brca.pdx.list$ind4
Idents(ind4)<- "integrated_cell_type_renamed"
ind4.basal<-subset(ind4, idents = "basal")

ind9<-norm.brca.pdx.list$ind9
Idents(ind9)<- "integrated_cell_type_renamed"
ind9.basal<-subset(ind9, idents = "basal")
```
```{r sctransform.integrate.pdx.by.basal, eval = FALSE, echo=FALSE}
sctransform.object.list.basal<-list("hci001"=hci001,
                                    "hci002"=hci002,
                                    "hci010"=hci010,
                                    "ind1"=ind1.basal,
                                    "ind10"=ind10.basal,
                                    "ind2"=ind2.basal,
                                    "ind3"=ind3.basal,
                                    "ind4"=ind4.basal,
                                    "ind9"=ind9.basal)

for (i in 1:length(sctransform.object.list.basal)) {
    sctransform.object.list.basal[[i]] <- SCTransform(sctransform.object.list.basal[[i]], verbose = FALSE)
}

norm.brca.pdx.features.3000.basal <- SelectIntegrationFeatures(object.list = sctransform.object.list.basal, 
                                                         nfeatures = 3000)

options(future.globals.maxSize = (6000*1024^2))

norm.brca.pdx.features.list.3000.basal <- PrepSCTIntegration(object.list = sctransform.object.list.basal, 
                                                  anchor.features = norm.brca.pdx.features.3000.basal, 
                                                  verbose = FALSE)

norm.brca.pdx.anchors.basal <- FindIntegrationAnchors(object.list = norm.brca.pdx.features.list.3000.basal, normalization.method = "SCT", 
    anchor.features = norm.brca.pdx.features.3000.basal, verbose = FALSE)

memory.size(max = TRUE)

norm.brca.pdx.integrated.basal <- IntegrateData(anchorset = norm.brca.pdx.anchors.basal, normalization.method = "SCT", 
    verbose = FALSE)
```
```{r sctransform.integrate.pdx.by.basal.dim.reduce, eval = FALSE, echo=FALSE}
norm.brca.pdx.integrated.basal <- RunPCA(norm.brca.pdx.integrated.basal, verbose = FALSE)
norm.brca.pdx.integrated.basal <- RunUMAP(norm.brca.pdx.integrated.basal, dims = 1:30)
```
```{r sctransform.integrate.pdx.by.basal.umap.visualize, fig.height=8, fig.width=12}
load(file = "E:\\Scripts\\Seurat\\Seurat3_Objects\\norm.brca.pdx.expectedcounts.integrated.basal.sctransform.3000features.SeuratObject.Rda")
plot1<-DimPlot(norm.brca.pdx.integrated.basal,reduction = "umap",split.by = "combined_chemistry", group.by = "combined_chemistry",pt.size = 1)
plot2<-DimPlot(norm.brca.pdx.integrated.basal,reduction = "umap",split.by = "integrated_cell_type_renamed", group.by = "integrated_cell_type_renamed",pt.size = 1)
plot_grid(plot1,plot2, ncol = 1)
```

## Integrate PDX cells with Luminal1 Cells

```{r sctransform.subset.norm.brca.luminal1, eval=FALSE, echo=FALSE}
ind1<-norm.brca.pdx.list$ind1
Idents(ind1)<- "integrated_cell_type_renamed"
ind1.luminal1<-subset(ind1, idents = "luminal1")

ind10<-norm.brca.pdx.list$ind10
Idents(ind10)<- "integrated_cell_type_renamed"
ind10.luminal1<-subset(ind10, idents = "luminal1")

ind2<-norm.brca.pdx.list$ind2
Idents(ind2)<- "integrated_cell_type_renamed"
ind2.luminal1<-subset(ind2, idents = "luminal1")

ind3<-norm.brca.pdx.list$ind3
Idents(ind3)<- "integrated_cell_type_renamed"
ind3.luminal1<-subset(ind3, idents = "luminal1")

ind4<-norm.brca.pdx.list$ind4
Idents(ind4)<- "integrated_cell_type_renamed"
ind4.luminal1<-subset(ind4, idents = "luminal1")

ind9<-norm.brca.pdx.list$ind9
Idents(ind9)<- "integrated_cell_type_renamed"
ind9.luminal1<-subset(ind9, idents = "luminal1")
```
```{r sctransform.integrate.pdx.by.luminal1, eval = FALSE, echo=FALSE}
sctransform.object.list.luminal1<-list("hci001"=hci001,
                                    "hci002"=hci002,
                                    "hci010"=hci010,
                                    "ind1"=ind1.luminal1,
                                    "ind10"=ind10.luminal1,
                                    "ind2"=ind2.luminal1,
                                    "ind3"=ind3.luminal1,
                                    "ind4"=ind4.luminal1,
                                    "ind9"=ind9.luminal1)

for (i in 1:length(sctransform.object.list.luminal1)) {
    sctransform.object.list.luminal1[[i]] <- SCTransform(sctransform.object.list.luminal1[[i]], verbose = FALSE)
}

norm.brca.pdx.features.3000.luminal1 <- SelectIntegrationFeatures(object.list = sctransform.object.list.luminal1, 
                                                         nfeatures = 3000)

options(future.globals.maxSize = (6000*1024^2))

norm.brca.pdx.features.list.3000.luminal1 <- PrepSCTIntegration(object.list = sctransform.object.list.luminal1, 
                                                  anchor.features = norm.brca.pdx.features.3000.luminal1, 
                                                  verbose = FALSE)

norm.brca.pdx.anchors.luminal1 <- FindIntegrationAnchors(object.list = norm.brca.pdx.features.list.3000.luminal1, normalization.method = "SCT", 
    anchor.features = norm.brca.pdx.features.3000.luminal1, verbose = FALSE)

memory.size(max = TRUE)

norm.brca.pdx.integrated.luminal1 <- IntegrateData(anchorset = norm.brca.pdx.anchors.luminal1, normalization.method = "SCT", 
    verbose = FALSE)
```
```{r sctransform.integrate.pdx.by.luminal1.dim.reduce, eval = FALSE, echo=FALSE}
norm.brca.pdx.integrated.luminal1 <- RunPCA(norm.brca.pdx.integrated.luminal1, verbose = FALSE)
norm.brca.pdx.integrated.luminal1 <- RunUMAP(norm.brca.pdx.integrated.luminal1, dims = 1:30)
```
```{r sctransform.integrate.pdx.by.luminal1.umap.visualize, fig.height=8, fig.width=12}
load(file = "E:\\Scripts\\Seurat\\Seurat3_Objects\\norm.brca.pdx.expectedcounts.integrated.luminal1.sctransform.3000features.SeuratObject.Rda")
plot1<-DimPlot(norm.brca.pdx.integrated.luminal1,reduction = "umap",split.by = "combined_chemistry", group.by = "combined_chemistry",pt.size = 1)
plot2<-DimPlot(norm.brca.pdx.integrated.luminal1,reduction = "umap",split.by = "integrated_cell_type_renamed", group.by = "integrated_cell_type_renamed",pt.size = 1)
plot_grid(plot1,plot2, ncol = 1)
```

## Label Transfer

```{r label.transfer.prep, eval=TRUE, echo=FALSE}
#HCI001
load("seurat-objects/hci001.expected.counts.trimmed.seurat3.object.Rda")
#HCI002
load("seurat-objects/hci002.expected.counts.trimmed.seurat3.object.Rda")
#HCI010
load("seurat-objects/hci010.expected.counts.trimmed.seurat3.object.Rda")
#Norm/BRCA
load("seurat-objects/norm.brca.integrated.epithelial.Rda")

#Load TPM Seurat Objects to Transfer MetaData
load("seurat-objects/hci001.seurat3.object.Rda")
load("seurat-objects/hci002.seurat3.object.Rda")
load("seurat-objects/hci010.seurat3.object.Rda")

#Reorder HCI001 Meta Data
p01.cc.updated[["cell.names"]]<-rownames(p01.cc.updated@meta.data)
p01.cc.updated@meta.data<-arrange(p01.cc.updated@meta.data, cell.names)
rownames(p01.cc.updated@meta.data)<-as.character(p01.cc.updated$cell.names)

p01.counts[["cell.names"]]<-rownames(p01.counts@meta.data)
p01.counts@meta.data<-arrange(p01.counts@meta.data, cell.names)
rownames(p01.counts@meta.data)<-as.character(p01.counts$cell.names)

#Add HCI001 Meta Data to Counts Seurat Object
p01.counts[["mouse"]]<-p01.cc.updated$mouse
p01.counts[["burden"]]<-p01.cc.updated$burden
p01.counts[["tissue"]]<-p01.cc.updated$tissue
p01.counts[["paper.ident"]]<-p01.cc.updated$paper.ident
p01.counts[["pdx.surgery.type"]]<-p01.cc.updated$pdx.surgery.type
p01.counts[["pdx.surgical.side"]]<-p01.cc.updated$pdx.surgical.side

#Reorder HCI002 Meta Data
p02.updated[["cell.names"]]<-rownames(p02.updated@meta.data)
p02.updated@meta.data<-arrange(p02.updated@meta.data, cell.names)
rownames(p02.updated@meta.data)<-as.character(p02.updated$cell.names)

p02.counts[["cell.names"]]<-rownames(p02.counts@meta.data)
p02.counts@meta.data<-arrange(p02.counts@meta.data, cell.names)
rownames(p02.counts@meta.data)<-as.character(p02.counts$cell.names)

#Add HCI002 Meta Data to Counts Seurat Object
p02.counts[["mouse"]]<-p02.updated$mouse
p02.counts[["burden"]]<-p02.updated$burden
p02.counts[["tissue"]]<-p02.updated$tissue
p02.counts[["paper.ident"]]<-p02.updated$paper.ident
p02.counts[["pdx.surgery.type"]]<-p02.updated$pdx.surgery.type
p02.counts[["pdx.surgical.side"]]<-p02.updated$pdx.surgical.side

#Reorder HCI010 Meta Data
p10.updated[["cell.names"]]<-rownames(p10.updated@meta.data)
p10.updated@meta.data<-arrange(p10.updated@meta.data, cell.names)
rownames(p10.updated@meta.data)<-as.character(p10.updated$cell.names)

p10.counts[["cell.names"]]<-rownames(p10.counts@meta.data)
p10.counts@meta.data<-arrange(p10.counts@meta.data, cell.names)
rownames(p10.counts@meta.data)<-as.character(p10.counts$cell.names)

#Add HCI010 Meta Data to Counts Seurat Object
p10.counts[["mouse"]]<-p10.updated$mouse
p10.counts[["burden"]]<-p10.updated$burden
p10.counts[["tissue"]]<-p10.updated$tissue
p10.counts[["paper.ident"]]<-p10.updated$paper.ident
p10.counts[["pdx.surgery.type"]]<-p10.updated$pdx.surgery.type
p10.counts[["pdx.surgical.side"]]<-p10.updated$pdx.surgical.side
```
```{r label.transfer.calculation, eval=TRUE, echo=FALSE}
hci001.query <- p01.counts
DefaultAssay(norm.brca.integrated.epithelial)<-"integrated"
hci001.anchors <- FindTransferAnchors(reference = norm.brca.integrated.epithelial, query = hci001.query, 
    dims = 1:30)
predictions <- TransferData(anchorset = hci001.anchors, refdata = norm.brca.integrated.epithelial$Coarse.Ident, 
    dims = 1:30)
hci001.query <- AddMetaData(hci001.query, metadata = predictions)

hci002.query <- p02.counts
DefaultAssay(norm.brca.integrated.epithelial)<-"integrated"
hci002.anchors <- FindTransferAnchors(reference = norm.brca.integrated.epithelial, query = hci002.query, 
    dims = 1:30)
predictions <- TransferData(anchorset = hci002.anchors, refdata = norm.brca.integrated.epithelial$Coarse.Ident, 
    dims = 1:30)
hci002.query <- AddMetaData(hci002.query, metadata = predictions)

hci010.query <- p10.counts
DefaultAssay(norm.brca.integrated.epithelial)<-"integrated"
hci010.anchors <- FindTransferAnchors(reference = norm.brca.integrated.epithelial, query = hci010.query, 
    dims = 1:30)
predictions <- TransferData(anchorset = hci010.anchors, refdata = norm.brca.integrated.epithelial$Coarse.Ident, 
    dims = 1:30)
hci010.query <- AddMetaData(hci010.query, metadata = predictions)
```

```{r label.transfer.visualize.hci001, eval=TRUE, echo=FALSE, fig.height=4, fig.width=7}
hci001.prediction.plot<-FetchData(hci001.query, c("tissue",
                                                  "paper.ident",
                                                  "predicted.id",
                                                  "cell.names",
                                                  "prediction.score.NORMAL.Basal",
                                                  "prediction.score.NORMAL.Luminal_1",
                                                  "prediction.score.NORMAL.Luminal_2",
                                                  "prediction.score.BRCA.Basal",
                                                  "prediction.score.BRCA.Luminal_1",
                                                  "prediction.score.BRCA.Luminal_2"))
levels(hci001.prediction.plot$tissue)<-c("Metastatic","Tumor")
hci001.prediction.plot.melted<-melt(hci001.prediction.plot)

ggplot(hci001.prediction.plot.melted, aes(value, fill=tissue))+
  geom_histogram(binwidth = 0.01)+
  ggtitle("Prediction Score HCI001")+
  theme_classic()+
  facet_wrap(~ variable)

hci001.prediction.heatmap.labels<-hci001.prediction.plot[,1:2]
colnames(hci001.prediction.heatmap.labels)<-c("Status","Paper ID")

colors<-brewer.pal(5, "Dark2")
hci001.prediction.heatmap.colors<-list("Status" = c("Tumor"=colors[1],"Metastatic"=colors[2]),
                                       "Paper ID" = c("A1"=colors[3],"A2"=colors[4],"A3"=colors[5]))

hci001.prediction.heatmap<-t(hci001.prediction.plot[,5:10])
rownames(hci001.prediction.heatmap)<-c("Normal Basal",
                                       "Normal Luminal 1",
                                       "Normal Luminal 2",
                                       "BRCA Basal",
                                       "BRCA Luminal 1",
                                       "BRCA Luminal 2")

sort_hclust <- function(...) as.hclust(dendsort(as.dendrogram(...)))
mat_cluster_cols <- hclust(dist(t((as.matrix(hci001.prediction.heatmap)))))
mat_cluster_cols <- sort_hclust(mat_cluster_cols)
mat_cluster_rows <- sort_hclust(hclust(dist(as.matrix(hci001.prediction.heatmap))))

pheatmap((as.matrix(hci001.prediction.heatmap)),
         scale = "column",
         show_colnames = F,
         cluster_cols = mat_cluster_cols,
         cluster_rows = mat_cluster_rows,
         color = PurpleAndYellow(50),
         annotation_col = hci001.prediction.heatmap.labels,
         annotation_colors = hci001.prediction.heatmap.colors,
         cutree_cols = 3)
```
```{r label.transfer.visualize.hci002, eval=TRUE, echo=FALSE, fig.height=4, fig.width=8}
hci002.prediction.plot<-FetchData(hci002.query, c("tissue",
                                                  "paper.ident",
                                                  "predicted.id",
                                                  "cell.names",
                                                  "prediction.score.NORMAL.Basal",
                                                  "prediction.score.NORMAL.Luminal_1",
                                                  "prediction.score.NORMAL.Luminal_2",
                                                  "prediction.score.BRCA.Basal",
                                                  "prediction.score.BRCA.Luminal_1",
                                                  "prediction.score.BRCA.Luminal_2"))
levels(hci002.prediction.plot$tissue)<-c("Metastatic","Metastatic","Tumor")
hci002.prediction.plot.melted<-melt(hci002.prediction.plot)

ggplot(hci002.prediction.plot.melted, aes(value, fill=tissue))+
  geom_histogram(binwidth = 0.01)+
  ggtitle("Prediction Score hci002")+
  theme_classic()+
  facet_wrap(~ variable)

hci002.prediction.heatmap.labels<-hci002.prediction.plot[,1:2]
colnames(hci002.prediction.heatmap.labels)<-c("Status","Paper ID")

colors<-brewer.pal(7, "Dark2")
hci002.prediction.heatmap.colors<-list("Status" = c("Tumor"=colors[1],"Metastatic"=colors[2]),
                                       "Paper ID" = c("B1"=colors[3],"B2"=colors[4],"B3"=colors[5],"B4"=colors[6],"B5"=colors[7]))

hci002.prediction.heatmap<-t(hci002.prediction.plot[,5:10])
rownames(hci002.prediction.heatmap)<-c("Normal Basal",
                                       "Normal Luminal 1",
                                       "Normal Luminal 2",
                                       "BRCA Basal",
                                       "BRCA Luminal 1",
                                       "BRCA Luminal 2")

sort_hclust <- function(...) as.hclust(dendsort(as.dendrogram(...)))
mat_cluster_cols <- hclust(dist(t((as.matrix(hci002.prediction.heatmap)))))
mat_cluster_cols <- sort_hclust(mat_cluster_cols)
mat_cluster_rows <- sort_hclust(hclust(dist(as.matrix(hci002.prediction.heatmap))))

pheatmap((as.matrix(hci002.prediction.heatmap)),
         scale = "column",
         show_colnames = F,
         cluster_cols = mat_cluster_cols,
         cluster_rows = mat_cluster_rows,
         color = PurpleAndYellow(50),
         annotation_col = hci002.prediction.heatmap.labels,
         annotation_colors = hci002.prediction.heatmap.colors,
         cutree_cols = 5)
```
```{r label.transfer.visualize.hci010, eval=TRUE, echo=FALSE, fig.height=4, fig.width=9}
hci010.prediction.plot<-FetchData(hci010.query, c("tissue",
                                                  "paper.ident",
                                                  "predicted.id",
                                                  "cell.names",
                                                  "prediction.score.NORMAL.Basal",
                                                  "prediction.score.NORMAL.Luminal_1",
                                                  "prediction.score.NORMAL.Luminal_2",
                                                  "prediction.score.BRCA.Basal",
                                                  "prediction.score.BRCA.Luminal_1",
                                                  "prediction.score.BRCA.Luminal_2"))
levels(hci010.prediction.plot$tissue)<-c("Metastatic","Metastatic","Tumor")
hci010.prediction.plot.melted<-melt(hci010.prediction.plot)

ggplot(hci010.prediction.plot.melted, aes(value, fill=tissue))+
  geom_histogram(binwidth = 0.01)+
  ggtitle("Prediction Score hci010")+
  theme_classic()+
  facet_wrap(~ variable)

hci010.prediction.heatmap.labels<-hci010.prediction.plot[,1:2]
colnames(hci010.prediction.heatmap.labels)<-c("Status","Paper ID")

colors<-brewer.pal(8, "Dark2")
hci010.prediction.heatmap.colors<-list("Status" = c("Tumor"=colors[1],"Metastatic"=colors[2]),
                                       "Paper ID" = c("C1"=colors[3],"C2"=colors[4],"C3"=colors[5],"C4"=colors[6],"C5"=colors[7],"C6"=colors[8]))

hci010.prediction.heatmap<-t(hci010.prediction.plot[,5:10])
rownames(hci010.prediction.heatmap)<-c("Normal Basal",
                                       "Normal Luminal 1",
                                       "Normal Luminal 2",
                                       "BRCA Basal",
                                       "BRCA Luminal 1",
                                       "BRCA Luminal 2")

sort_hclust <- function(...) as.hclust(dendsort(as.dendrogram(...)))
mat_cluster_cols <- hclust(dist(t((as.matrix(hci010.prediction.heatmap)))))
mat_cluster_cols <- sort_hclust(mat_cluster_cols)
mat_cluster_rows <- sort_hclust(hclust(dist(as.matrix(hci010.prediction.heatmap))))

pheatmap((as.matrix(hci010.prediction.heatmap)),
         scale = "column",
         show_colnames = F,
         cluster_cols = mat_cluster_cols,
         cluster_rows = mat_cluster_rows,
         color = PurpleAndYellow(50),
         annotation_col = hci010.prediction.heatmap.labels,
         annotation_colors = hci010.prediction.heatmap.colors,
         cutree_cols = 5)
```

```{r calculate.norm.brca.coarse.ident.markers, echo=TRUE, eval=FALSE}
DefaultAssay(norm.brca.integrated.epithelial)<"RNA"
Idents(norm.brca.integrated.epithelial)<-"Coarse.Ident"
norm.brca.epithelial.coarse.ident.markers <- FindAllMarkers(norm.brca.integrated.epithelial, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
write.table(norm.brca.epithelial.coarse.ident.markers, file = "marker_genes/norm.brca.epithelial.coarse.ident.markers.txt",sep = "\t")
```

```{r calculate.module.scores.markers. echo=TRUE, eval=TRUE}
norm.brca.epithelial.coarse.ident.markers<-read.table("marker_genes/norm.brca.epithelial.coarse.ident.markers.txt",sep = "\t")

normal.basal.markers<-subset(norm.brca.epithelial.coarse.ident.markers, cluster=="NORMAL.Basal")
normal.luminal1.markers<-subset(norm.brca.epithelial.coarse.ident.markers, cluster=="NORMAL.Luminal_1")
normal.luminal2.markers<-subset(norm.brca.epithelial.coarse.ident.markers, cluster=="NORMAL.Luminal_2")
brca.basal.markers<-subset(norm.brca.epithelial.coarse.ident.markers, cluster=="BRCA.Basal")
brca.luminal1.markers<-subset(norm.brca.epithelial.coarse.ident.markers, cluster=="BRCA.Luminal_1")
brca.luminal2.markers<-subset(norm.brca.epithelial.coarse.ident.markers, cluster=="BRCA.Luminal_2")


```

## Save Seurat Objects (Last Saved: 04/23/20)

```{r sctransform.save.object, eval = FALSE}
#save(norm.brca.pdx.integrated, file="E:\\Scripts\\Seurat\\Seurat3_Objects\\norm.brca.pdx.expectedcounts.integrated.sctransform.3000features.SeuratObject.Rda")
#save(norm.brca.pdx.integrated.basal, file = "E:\\Scripts\\Seurat\\Seurat3_Objects\\norm.brca.pdx.expectedcounts.integrated.basal.sctransform.3000features.SeuratObject.Rda")
#save(norm.brca.pdx.integrated.luminal1, file = "E:\\Scripts\\Seurat\\Seurat3_Objects\\norm.brca.pdx.expectedcounts.integrated.luminal1.sctransform.3000features.SeuratObject.Rda")
```