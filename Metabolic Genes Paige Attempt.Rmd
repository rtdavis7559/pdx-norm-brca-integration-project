---
title: "Metabolic Gene Identification"
author: "Paige"
date: "4/13/2020"
output: html_document
---
## Load R packages
#Suerat, ggplot2, cowplot, dict, readxl
```{r import.libraries}
library(Seurat)
library(ggplot2)
library(cowplot)
#install the dict package from github to create a dictionary 
#if (!require("devtools")) install.packages("devtools")
#devtools::install_github("mkuhn/dict")
#load the dict library 
library(dict)
#to read in the Excel file 
library(readxl)
```

## Import List of Metabolic Genes 

```{r import.list.of.metabolic.genes}
#name your dictionary 
mydict <- dict()
#prepare an excel file of all the genes where every column is a pathway name and its respective list of genes 
#import list
rest_genes_V <- read_excel("~/Documents/UCI Grad School/CMB PhD Year 1/Lawson Lab/rest_genes_V.xlsx")
#convert list of genes into characters 
rest_genes_V <- as.character(rest_genes_V)
```

## Make lists from each of the columns in the Excel file and save them in the dictionary

```{r configure.excel.to.make.lists}
#for loop to make add to the dictionary where the pathway is the key and the value is the list of genes in that pathway: i.e. Oxphos is the key and its genes are the value
for(i in colnames(rest_genes_V)){
  mydict[[i]] <- lapply(as.list(rest_genes_V[i]), function(x) x[!x %in% ""])
}

```

## Import the Norm/BRCA dataset that will be analyzed 

```{r import.Norm.BRCA.data}
load("seurat-objects/norm.brca.integrated.epithelial.Rda")
Norm.BRCA <- norm.brca.integrated.epithelial
```

## Add module scores to the RNA assay in the Norm/BRCA dataset

```{r add.module.scores}
#set the DefaultAssay for the Norm.BRCA to be RNA 
DefaultAssay(Norm.BRCA)<-"RNA"

#loop through the dictionary to calculate the module scores for each key in the dictionary (i.e. each pathway (key) and its genes (values))
#need to set the object equal to a different variable so it can be seperately tracked
#in for loop you need to set object equal to itself or else it keeps writing itself over and not adding to the metadata as it calculates module scoring
x=Norm.BRCA
for (i in (mydict$keys())){
  print(i)
  x <- AddModuleScore(object = x,
                              features = mydict[[i]],
                              name = i,
                             assay = "RNA")
                         
}
#print(paste("Calculating",names(metabolism.pathway.1[i])))
```

## Test to see if this calculation worked by using a sample dataset

```{r test.to.see.if.calculation.worked, echo = FALSE, eval = FALSE}
#test to see if you can plot one of the metadafeatures 
VlnPlot(x, features = "Tryptophan.metabolism1", assay = "RNA", group.by = "Cell.Type")
```

## Generate a new matrix to look at the relevent info we want to plot (cell type, pathways, status, and score)

```{r make.a.new.matrix.where.you.are.looking.at.cell.type.status.pathways.and.scores}
#load required packages
library(reshape2)
library(ggplot2)
#making the new matrix to build box plots off of with all the pathways calculated
S.metabolism.box.plot.matrix<- cbind(x@meta.data[,13], x@meta.data[,8], x@meta.data[,33:69])
S.metabolism.box.plot.matrix.melted<-melt(S.metabolism.box.plot.matrix)
#renaming the columns to be interpretible values
colnames(S.metabolism.box.plot.matrix.melted)<-c("cell.type","status","pathway","score")
```

## Plot Pathway Scores 

```{r plotting.pathway.scores, fig.height=4, fig.width=8}
ggplot(S.metabolism.box.plot.matrix.melted,
                                    aes(x=cell.type,
                                        y=score,
                                        fill=status))+
                                geom_boxplot()+
                                xlab("") + ylab("Gene Score")+
                                theme_classic()+
                                theme(legend.title = element_blank())+
                                geom_hline(yintercept = 0,size=1, color="black")+
                                facet_wrap(~pathway, scales = "free")
```

## Plot Metabolic Pathway scores based on cell type 

```{r plotting.based.on.color.and.cell.type, fig.height=4, fig.width=8 }
#plot and color by cell type
ggplot(S.metabolism.box.plot.matrix.melted,
                                    aes(x=status,
                                        y=score,
                                        fill=cell.type))+
                                geom_boxplot()+
                                xlab("") + ylab("Gene Score")+
                                theme_classic()+
                                theme(legend.title = element_blank())+
                                geom_hline(yintercept = 0,size=1, color="black")+
                                facet_wrap(~pathway, scales = "free")
```

## Plot only the pathways of interest (where BRCA is higher than Normal)

``` {r.plotting.only.boxplots.of.pathways.of.interest, fig.height=4, fig.width=8}
#making a new box plot matrix with only relevent pathways 
S.metabolism.interest.box.plot.matrix<- cbind(x@meta.data[,13], x@meta.data[,8], x@meta.data[,4], x@meta.data[,c(33,34,36,37,40,41,44,47,58,60,61,62)])
#melting matrix together
S.metabolism.interest.box.plot.matrix.melted<-melt(S.metabolism.interest.box.plot.matrix)
#renaming columns in new matrix
colnames(S.metabolism.interest.box.plot.matrix.melted)<-c("cell.type","status","individual","pathway","score")

#plotting matrix with pathways of interest
ggplot(S.metabolism.interest.box.plot.matrix.melted,
                                    aes(x=cell.type,
                                        y=score,
                                        fill=status,
                                        linetype=individual))+
                                geom_boxplot()+
                                xlab("") + ylab("Gene Score")+
                                theme_classic()+
                                theme(legend.title = element_blank())+
                                geom_hline(yintercept = 0,size=1, color="black")+
                                facet_wrap(~pathway, scales = "free")

plot_grid(plotlist = metabolism.vln.plots,ncol = 7)
```

##Plot for just glycolysis and oxphos 

```{r plot.cell.types.with.glycolysis.and.oxphos}
#do this for cell type with just glycolysis and Oxphos
ct.metabolism.interest.box.plot.matrix<- cbind(x@meta.data[,13], x@meta.data[,8], x@meta.data[,4], x@meta.data[,c(33,34)])
ct.metabolism.interest.box.plot.matrix.melted<-melt(ct.metabolism.interest.box.plot.matrix)
colnames(ct.metabolism.interest.box.plot.matrix.melted)<-c("cell.type","status","individual","pathway","score")
#plot just the glycolysis and oxphos datapoints 
ggplot(ct.metabolism.interest.box.plot.matrix.melted,
                                    aes(x=status,
                                        y=score,
                                        fill=cell.type,
                                        linetype=individual))+
                                geom_boxplot()+
                                xlab("") + ylab("Gene Score")+
                                theme_classic()+
                                theme(legend.title = element_blank())+
                                geom_hline(yintercept = 0,size=1, color="black")+
                                facet_wrap(~pathway, scales = "free")
```
